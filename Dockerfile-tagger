FROM python:3.11-slim-bookworm

# Set working directory
WORKDIR /app

# Install system dependencies for health checks
RUN apt-get update && apt-get install -y curl && rm -rf /var/lib/apt/lists/*

# Copy requirements first to leverage Docker cache
COPY tagger/requirements.txt .

# Install CPU-only PyTorch first to avoid CUDA dependencies
# Using compatible versions matching teleaiagent
RUN pip3 install --no-cache-dir torch==2.4.0+cpu torchvision==0.19.0+cpu torchaudio==2.4.0+cpu --index-url https://download.pytorch.org/whl/cpu

# Install SentenceTransformers (matching teleaiagent) - CPU only
RUN pip3 install --no-cache-dir sentence-transformers==3.0.1

# Install remaining Python dependencies
RUN pip3 install --no-cache-dir -r requirements.txt

# Remove build dependencies to reduce image size
RUN apt-get update && apt-get autoremove -y && \
    rm -rf /var/lib/apt/lists/*

# Copy the entire tagger application
COPY tagger/ .

# Create necessary directories
RUN mkdir -p /app/logs /app/images /app/volume_images

# Set environment variables
ENV PYTHONUNBUFFERED=1
ENV RUNNING_IN_DOCKER=true
# Force CPU-only mode for PyTorch and transformers
ENV CUDA_VISIBLE_DEVICES=""
ENV TORCH_USE_CUDA_DSA=0
ENV PYTORCH_ENABLE_MPS_FALLBACK=1

# Expose the service port
EXPOSE 7777

# Health check
HEALTHCHECK --interval=30s --timeout=10s --start-period=40s --retries=3 \
    CMD curl -f http://localhost:7777/health || exit 1

# Run the tagger service
CMD ["python3", "main.py"]